<html>

<head>
    <meta charset="UTF-8">
    <title></title>
</head>

<script src="./dapi.js"></script>
<script src="./sdk.js"></script>
<script>

    var client

    //DAPI Test
    async function dapi() {

        client = dApi.client;
        client.registerClient({});

        //Get Address
        const account = await client.api.asset.getAccount();
        document.getElementById("account").innerHTML = account;

        //Get balance
        const balance = await client.api.network.getBalance({ address: account });
        document.getElementById("ong").innerHTML = balance.ONG;
        document.getElementById("ont").innerHTML = balance.ONT;
        document.getElementById("gwt").innerHTML = balance.GWT;
        document.getElementById("mrt").innerHTML = balance.MRT;

        //const identity = await 
        const identity = await client.api.identity.getIdentity();
        document.getElementById("identity").innerHTML = identity;

    }

    async function transfer() {
        const to = 'AXCyYV4DNmmsqZn9qJEqHqpacVxcr7X7ns';
        const asset = 'GWT';
        const amount = 10;
        const result = await client.api.asset.send({ to, asset, amount });
        console.log(result)
    }

    //SDK test
    async function createIdentity() {
        console.log(Ont.Crypto)
        var wallet = await Ont.Wallet.create('test');
        //Private key 生成
        const privateKey = Ont.Crypto.PrivateKey.random();

        console.log(privateKey)

        //Identity作成
        const password = "issuer"
        const label = "issuer"
        var identity = Ont.Identity.create(privateKey, password, label)

        console.log(identity)

        const did = identity.ontid;
        const pk = privateKey.getPublicKey();
        const gasPrice = '500';
        const gasLimit = '20000';
        const tx = Ont.OntidContract.buildRegisterOntidTx(did, pk, gasPrice, gasLimit);
        tx.payer = new Ont.Crypto.Address("AemAjf8JSPkTdnXMmqeu6LRw5Ja3rvZV7y");

        Ont.TransactionBuilder.signTransaction(tx, privateKey);

        const pri = Ont.Crypto.PrivateKey.deserializeWIF('L5NBY1AaWje2duAXLfb1gK8Srrsu45bpKFCB84jdNnaynPHRmFKH');

        const account = Ont.Account.create(pri, '123456', '');
        console.log('address: ' + account.address.toBase58());

        //Then sign the transaction with payer's account
        //we already got transaction created before,add the signature.
        Ont.TransactionBuilder.addSign(tx, pri)

        const rest = new Ont.RestClient();

        console.log(tx)

        rest.sendRawTransaction(tx.serialize(), false).then(res => {
            console.log(res);
        })
    }

    function buildClaim() {
        const signature = null;
        const useProof = false;

        const claim = new Ont.Claim({
            // messageId: Ont.Crypto.PrivateKey.random().key,
            messageId: "cerverified",
            issuer: 'did:ont:AUvSmqnWDG5mseaecdcMfk3w98rwrKamzK',
            subject: 'did:ont:AFzmBSzuAsx9fVvKU9TmQdYWmwDTMjHyL4',
            issueAt: 1525800823
        }, signature, useProof);

        claim.version = '0.7.0';
        //This can be ignored for now

        claim.context = 'https://example.com/template/v1';
        claim.content = {
            event: {
              name: "Ontology Blockchain Hackathon Tokyo #1",
              url: "https://ontology.connpass.com/event/106684/",
              image_url: "https://connpass-tokyo.s3.amazonaws.com/thumbs/2a/22/2a22848978459a1258d39959dea85ef8.png"
            },
            entry: {
              name: "mosa",
              image_url: "https://pbs.twimg.com/profile_images/378800000214753541/b3fdd930163a330b670a45b483606574_400x400.jpeg"
            },
            team: {
              name: "team_satoshi",
              members: [], // did array
            },
            submitted: {
              url: "https://github.com/mosasiru/japan-hackathon-box",
              title: "Cerverified",
              description: "attest you attend the event",
              image_url: ""
            },
            awrd: {
              title: "Best award",
              description: "best!!!",
              image_url: "",
            }
        };
        return claim;

    }

    async function issueClaim() {
        const claim = buildClaim();

        const url2 = 'http://polaris1.ont.io:20334';

        const publicKeyId = "did:ont:AUvSmqnWDG5mseaecdcMfk3w98rwrKamzK" + "#keys-1"
        const issuerPriv = new Ont.Crypto.PrivateKey('2d56133d1047d7700fb908a93253a58da479774a6321f0d11040c9096dc24f33');

        await claim.sign(url2, publicKeyId, issuerPriv)
        console.log(claim)
        singed = claim.serialize();

        const url = 'ws://polaris1.ont.io:20335';

        const gasPrice = '500';
        const gasLimit = '200000';
        const payer = new Ont.Crypto.Address('AemAjf8JSPkTdnXMmqeu6LRw5Ja3rvZV7y');
        const privateKey = Ont.Crypto.PrivateKey.deserializeWIF('L5NBY1AaWje2duAXLfb1gK8Srrsu45bpKFCB84jdNnaynPHRmFKH')
        const result = await claim.attest(url, gasPrice, gasLimit, payer, privateKey);
        console.log(result)

        const result2 = await claim.getStatus(url2);
        //console.log(result2)

        const msg = Ont.Claim.deserialize(singed);
        var verified =  await msg.verify(url2, false)
   
        console.log(verified)


        // addAttribute
        // [TODO] sign via dAPI. now fixed sunject,
        const walletPrivateKey = new Ont.Crypto.PrivateKey("b575449ca2902a11e2f4f1ba819d26015844eff774775d67b93c507e92d0b8f1");
        const walletIdentityPrivateKey = new Ont.Crypto.PrivateKey("61d553c5a07a26f1ebb8ff4035fb28757673b2e40a77c933af6816e1f5f5d0a5");


        const attr = new Ont.DDOAttribute();
        attr.key = claim.metadata.messageId;
        attr.type = 'JSON';
        attr.value = JSON.stringify({
            Type : 'JSON',
            Value: claim
        });

        const identity = "did:ont:AYmpvkUHi5GzkXbeMscrkkzGco9nyNGNjX";
        const account = "ANCF6qRbF5WvGKRRcZdKrcKah4FWiP34br";
        const address = new Ont.Crypto.Address(account);

        const tx = Ont.OntidContract.buildAddAttributeTx(identity, [attr], walletIdentityPrivateKey.getPublicKey(), gasPrice, gasLimit);
        tx.payer = address;
        Ont.TransactionBuilder.signTransaction(tx, walletPrivateKey);
        Ont.TransactionBuilder.addSign(tx, walletIdentityPrivateKey);
        const socketClient = new Ont.WebsocketClient(url);
        const res = await socketClient.sendRawTransaction(tx.serialize(), false, true);
        console.log(res);
    }

    dapi();



</script>


<body>

    Account:
    <p id="account"></p>

    ONG:
    <p id="ong"></p>

    ONT:
    <p id="ont"></p>

    Giwa Token:
    <p id="gwt"></p>

    Marianne:
    <p id="mrt"></p>

    Identity:
    <p id="identity"></p>

    Transfer 10 Giwa token to Giwa: AaNtG3kMH9iWG2sWWL3jQZUPjN9Q23VssQ:
    <br>
    <input type='button' onclick="transfer()" value="Transfer">

    <input type='button' onclick="createIdentity()" value="createIdentity">

    <input type='button' onclick="issueClaim()" value="IssueClaim">

</body>

</html>
